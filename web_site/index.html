<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh s√°ch s·∫£n ph·∫©m</title>
    <script>
        let cart = []; // Gi·ªè h√†ng t·∫°m th·ªùi

        async function loadProducts() {
            try {
                const response = await fetch("http://127.0.0.1:5000/products");
                const products = await response.json();
                let productList = document.getElementById("product-list");
                productList.innerHTML = "";

                products.forEach(product => {
                    productList.innerHTML += `
                        <div>
                            <img src="${product.image}" width="200">
                            <h3>${product.name}</h3>
                            <p>Gi√°: ${product.price} VND</p>
                            <input type="number" id="qty-${product.id}" value="1" min="1" style="width:50px;">
                            <button onclick="addToCart('${product.id}', '${product.name}', ${product.price})">
                                Th√™m v√†o gi·ªè
                            </button>
                        </div>
                    `;
                });
            } catch (error) {
                console.error("L·ªói t·∫£i s·∫£n ph·∫©m:", error);
            }
        }

        function addToCart(productId, productName, price) {
            let quantity = document.getElementById(`qty-${productId}`).value;
            quantity = parseInt(quantity);
            if (quantity <= 0) {
                alert("S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!");
                return;
            }

            let existing = cart.find(p => p.product_id === productId);
            if (existing) {
                existing.quantity += quantity;
            } else {
                cart.push({ product_id: productId, name: productName, price: price, quantity: quantity });
            }

            alert(`ƒê√£ th√™m ${quantity} s·∫£n ph·∫©m ${productName} v√†o gi·ªè h√†ng.`);
            console.log("Gi·ªè h√†ng hi·ªán t·∫°i:", cart);
        }

        async function placeOrder() {
            if (cart.length === 0) {
                alert("Gi·ªè h√†ng ƒëang tr·ªëng!");
                return;
            }

            let orderData = {
                name: prompt("Nh·∫≠p t√™n c·ªßa b·∫°n:"),
                phone: prompt("Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i:"),
                address: prompt("Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng:"),
                products: cart
            };

            if (!orderData.name || !orderData.phone || !orderData.address) {
                alert("B·∫°n c·∫ßn nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·∫∑t h√†ng!");
                return;
            }

            try {
                const response = await fetch("http://127.0.0.1:5000/orders", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    await processPayment(result.order_id);
                }
            } catch (error) {
                alert("L·ªói khi ƒë·∫∑t h√†ng, vui l√≤ng th·ª≠ l·∫°i!");
                console.error(error);
            }
        }

        async function processPayment(orderId) {
            try {
                const response = await fetch("http://127.0.0.1:5000/payments", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ order_id: orderId })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    cart = []; // X√≥a gi·ªè h√†ng sau khi thanh to√°n th√†nh c√¥ng
                }
            } catch (error) {
                alert("L·ªói khi thanh to√°n, vui l√≤ng th·ª≠ l·∫°i!");
                console.error(error);
            }
        }

        window.onload = loadProducts;
    </script>
</head>
<body>
    <h1>Danh s√°ch s·∫£n ph·∫©m</h1>
    <div id="product-list"></div>
    <button onclick="placeOrder()" style="margin-top:20px; padding:10px;">üõí ƒê·∫∑t h√†ng ngay</button>
</body>
</html>